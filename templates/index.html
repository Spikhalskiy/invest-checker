
<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Daily Profit Report</title>

		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script src="{{ url_for('static', filename='highcharts.js') }}"></script>
        <script src="{{ url_for('static', filename='exporting.js') }}"></script>


		<script type="text/javascript">
            function prepare_for_daily_profit(data) {
                var summary = jQuery.extend(true, {}, data);

                summary.dates.shift();
                var dates = summary.dates;

                var series = [];
                var series_dict = {};

                dates.forEach(function(date) {
                    summary.dataset.forEach(function(raw) {
                        var rec = raw.shift();

                        var series_piece_name = rec.pamm;

                        var series_piece = series_dict[series_piece_name];

                        if (isNaN(series_piece)) {
                            series_piece = {name: rec.pamm, data: []};
                            series_dict[series_piece_name] = series_piece;
                            series.push(series_piece);
                        }

                        var exists = false;
                        raw.forEach(function(rec) {
                            if (rec.date == date) {
                                series_piece.data.push(rec.profit_in_perc * 100); //*100 - %
                                exists = true;
                            }
                        });

                        if (!exists)
                            series_piece.data.push(0);

                    });
                });
                return {dates: dates, series: series}
            }

            function draw_daily_profit(daily_profit_prepared_data) {
                $('#daily_profit_container').highcharts({
                    chart: {
                        type: 'line',
                        marginRight: 130,
                        marginBottom: 25
                    },
                    title: {
                        text: 'Daily Profit',
                        x: -20 //center
                    },
                    subtitle: {
                        text: 'From FX-Trend, Gamma-IC sites',
                        x: -20
                    },
                    xAxis: {
                        categories: daily_profit_prepared_data.dates
                    },
                    yAxis: {
                        title: {
                            text: 'Profit (%)'
                        },
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    },
                    tooltip: {
                        valueSuffix: '%'
                    },
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'top',
                        x: -10,
                        y: 100,
                        borderWidth: 0
                    },
                    series: daily_profit_prepared_data.series
                });
            }

            function display_graphics_for_account_summary (jsonResponse) {
                var daily_profit_data = prepare_for_daily_profit(jsonResponse);
                draw_daily_profit(daily_profit_data);
            }


            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

            $.getJSON($SCRIPT_ROOT + '/accounts_summary?period=7', {}, function(data) {
                display_graphics_for_account_summary(data);
            });

		</script>
	</head>
	<body>

    <table>
        <tbody>
            <tr>
                <div id="daily_profit_container" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
            </tr>
            <tr>
                <td>

                </td>
                <td>

                </td>
            </tr>
        </tbody>
    </table>


	</body>
</html>
